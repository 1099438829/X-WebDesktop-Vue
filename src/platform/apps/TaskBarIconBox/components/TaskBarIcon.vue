/**
* Created by OXOYO on 2017/12/26.
*
*/

<style scoped lang="less" rel="stylesheet/less">
  .task-bar-icon {
    display: inline-block;
    width: 60px;
    height: 39px;
    margin: 0 4px;
    position: relative;
    user-select:none;
    &.task-bar-icon-pinned {
    }
    .task-bar-icon-main{
      width: 60px;
      height: 39px;
      line-height: 39px;
      text-align: center;
      position: relative;
      overflow: hidden;
      transition: all .2s ease-out;

      &:before {
        content: '';
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
        z-index: 10;
        background: transparent;
      }
      &.app-open {
        /*border: 1px solid rgba(0, 0, 0, .3);*/
        /*background: rgba(250, 253, 255, .3);*/
        border-radius: 2px;
        /*box-shadow: 0px 0px 2px 2px rgba(0, 0, 0, 0.1);*/
        box-shadow: 0 0 1px 1px rgba(0, 0, 0, .2);
        &:after {
          content: ' ';
          position: absolute;
          z-index: -1;
          /*background: red;*/
          /*background: rgba(250, 253, 255, .5);*/
          background: rgba(255, 255, 255, 0.3);
          /*opacity: .5;*/
          filter: blur(5px);
          left: 0;
          right: 0;
          top: 0;
          bottom: 0;
        }
      }
      &:hover {
        &:after {
          content: ' ';
          position: absolute;
          z-index: -1;
          /*background: red;*/
          /*background: rgba(250, 253, 255, .5);*/
          background: rgba(255, 255, 255, 0.3);
          /*opacity: .5;*/
          filter: blur(10px);
          left: 0;
          right: 0;
          top: 0;
          bottom: 0;
        }
        &.app-open {
          box-shadow: 0 0 1px 1px rgba(0, 0, 0, .3);
        }
        .app-icon-bg {
          display: block !important;
          filter: blur(6px);
        }
      }
    }
    .app-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      margin-left: -15px;
      margin-top: -15px;
      width: 30px;
      height: 30px;
      /*filter: drop-shadow(0 0 10px #ccc);*/
      /*background: hsla(0,0%,100%,.25) border-box;*/
      /*box-shadow: 0 0 0 1px hsla(0,0%,100%,.3) inset, 0 .5em 1em rgba(0, 0, 0, 0.6);*/
    }
    .app-icon-down {
      margin-left: -14px;
      margin-top: -14px;
    }
    .app-icon-bg {
      position: absolute;
      display: block;
      overflow: hidden;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: -1;
      filter: blur(50px);
      background-position: center top;
      transition: all .2s ease-out;
      /*background-size: cover;*/
      /*background-attachment: fixed;*/
    }
  }
</style>

<template>
  <div
    v-if="info.window.status === 'open' || info.taskBar.isPinned"
    class="task-bar-icon"
    :class="{ 'task-bar-icon-pinned': info.taskBar.isPinned }"
    @mousedown.left.stop.prevent="handlerMouseDown"
    @mouseup.left.stop.prevent="handlerMouseUp"
    @contextmenu.stop.prevent="handlerRightClick($event)"
    :title="info.app.title"
    :data-name="info.app.name"
  >
    <!-- 图标 -->
    <div class="task-bar-icon-main" :class="{ 'app-open': info.window.status === 'open' }" :data-name="info.app.name">
      <img class="app-icon" :class="{ 'app-icon-down': isMouseDown}" v-if="info.app.icon" :src="info.app.icon" :data-name="info.app.name">
      <div class="app-icon-bg" v-show="info.app.icon && info.window.status === 'open'" :style="appIconBg"></div>
    </div>
  </div>
</template>

<script>
  export default {
    name: 'TaskBarIcon',
    props: {
      info: {
        type: Object,
        default: function () {
          return {}
        },
        required: true
      },
      type: {
        type: String,
        required: true
      }
    },
    data () {
      return {
        isMouseDown: false
      }
    },
    computed: {
      appIconBg: function () {
        let _t = this
        let icon = _t.info.app.hasOwnProperty('icon') && _t.info.app.icon ? _t.info.app.icon : null
        if (!icon) {
          return {}
        }
//        console.log('icon', icon)
//        let img = require(icon)
        let img = icon
        return {
          backgroundImage: 'url(' + img + ')'
        }
      }
    },
    methods: {
      // 鼠标按下
      handlerMouseDown: function () {
        let _t = this
        _t.isMouseDown = true
      },
      // 鼠标抬起
      handlerMouseUp: function () {
        let _t = this
        _t.isMouseDown = false
        // 打开应用
        let appInfo = {..._t.info}
        /*
        // 判断应用是否已打开
        if (appInfo.window.status === 'open') {
          let tmpObj = {
            appInfo: appInfo,
            actionName: '',
            newSize: '',
            oldSize: '',
            newStyle: '',
            oldStyle: '',
            status: ''
          }
          let currentSize = appInfo.window.size
          let currentStyle = appInfo.window.style
          let oldSize = appInfo.window.oldSize || 'middle'
          let oldStyle = appInfo.window.oldStyle || {}
          // 判断当前窗口是否为最小化
          if (appInfo.window.size === 'min') {
            // 更新
            tmpObj['actionName'] = 'reset'
            tmpObj['oldSize'] = currentSize
            tmpObj['oldStyle'] = currentStyle
            tmpObj['newSize'] = oldSize
            tmpObj['newStyle'] = oldStyle
            tmpObj['status'] = 'open'
          } else {
            // 更新
            tmpObj['actionName'] = 'min'
            tmpObj['oldSize'] = currentSize
            tmpObj['oldStyle'] = currentStyle
            tmpObj['newSize'] = 'min'
            tmpObj['newStyle'] = {}
            tmpObj['status'] = 'open'
          }
          _t.$utils.bus.$emit('platform/window/size/change', tmpObj)
        } else if (appInfo.window.status === 'close') {

        }
        */
        _t.$utils.bus.$emit('platform/window/toggle', appInfo)
      },
      // 右键菜单
      handlerRightClick: function (event) {
        let _t = this
        console.log('event', event)
        let xVal = parseInt(event.clientX) - parseInt(event.offsetX)
        let yVal = parseInt(event.clientY) - parseInt(event.offsetY)
        let appName = event.target.dataset['name'] || _t.info.app.name || null
        // 菜单信息
        let contextMenuInfo = {
          isShow: true,
          x: xVal,
          y: yVal,
          target: 'taskBarIcon-' + _t.type,
          appName: appName,
          data: {
            ..._t.info
          },
          list: [
            {
              name: 'refresh',
              icon: {
                type: 'refresh',
                style: ''
              },
              text: '刷新',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/refresh'
              }
            },
            {
              name: 'fullScreen',
              icon: {
                type: 'arrow-expand',
                style: ''
              },
              text: '全屏',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/fullScreen/open'
              }
            },
            {
              name: 'cancelFullScreen',
              icon: {
                type: 'arrow-shrink',
                style: ''
              },
              text: '取消全屏',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/fullScreen/close'
              }
            },
            {
              name: 'wallpaper',
              icon: {
                type: '',
                style: ''
              },
              text: '切换壁纸',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/wallpaper/switch'
              }
            },
            {
              name: 'openApp',
              icon: {
                type: '',
                style: ''
              },
              text: '打开',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/app/open'
              }
            },
            {
              name: 'openAppInNewBrowserTab',
              icon: {
                type: '',
                style: ''
              },
              text: '在新标签页中打开',
              enable: _t.info.window.type === 'iframe' && _t.info.app.url,
              action: {
                type: 'bus',
                handler: 'platform/app/openInNewBrowserTab'
              }
            },
            {
              name: 'uninstallApp',
              icon: {
                type: '',
                style: ''
              },
              text: '卸载',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/app/uninstall'
              }
            },
            {
              name: 'pinToTaskBar',
              icon: {
                type: '',
                style: {
                  transform: 'rotate(90deg)'
                }
              },
              text: '将此程序锁定到任务栏',
              enable: !_t.info.taskBar.isPinned,
              action: {
                type: 'bus',
                handler: 'platform/taskBar/pin'
              }
            },
            {
              name: 'unpinToTaskBar',
              icon: {
                type: '',
                style: ''
              },
              text: '将此程序从任务栏解锁',
              enable: _t.info.taskBar.isPinned,
              action: {
                type: 'bus',
                handler: 'platform/taskBar/unpin'
              }
            },
            {
              name: 'closeApp',
              icon: {
                type: '',
                style: ''
              },
              text: '关闭',
              enable: true,
              action: {
                type: 'bus',
                handler: 'platform/app/close'
              }
            }
          ]
        }
        console.log('contextMenuInfo', contextMenuInfo)
        // 广播事件
        _t.$utils.bus.$emit('platform/contextMenu/show', contextMenuInfo)
      }
    }
  }
</script>
